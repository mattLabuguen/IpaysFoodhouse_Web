<div class="d-flex flex-row justify-content-end">
    <div class="input-group mb-3 w-25 me-auto">
        <input type="text" class="form-control" placeholder="Search" aria-label="Search" aria-describedby="basic-addon1" id="searchBox" oninput="search()">
    </div>
    <button type="button" class="btn btn-primary h-50" data-bs-toggle="modal" data-bs-target="#edit_category"><b>Edit Categories&nbsp;</b> <i class="fas fa-clipboard-list"></i></button>
    <button type="button" class="btn btn-success h-50 ms-3" data-bs-toggle="modal" data-bs-target="#add_product"><b>Add New Product&nbsp;</b> <i class="fas fa-plus-circle"></i></button>
    <button type="button" class="btn btn-danger h-50 ms-3" data-bs-toggle="modal" data-bs-target="#remove_product"><b>Remove Product&nbsp;</b> <i class="fas fa-minus-circle"></i></button>
</div>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th scope="col">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="mainCheck" onchange="checkAll()">
                </div>  
            </th>
            <th scope="col">#</th>
            <th scope="col">Image</th>
            <th scope="col">Category</th>
            <th scope="col">Product Name</th>
            <th scope="col">Price</th>
            <th scope="col">Status</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="tableBody">
        <%var id = 1%>
        <% for(menuItem of tableData){ %>
            <tr>
                <td><input class="form-check-input" type="checkbox" value='<%=menuItem["_id"]%>' name="checkRow"></td>
                <td><%=id%></td>
                <td>
                    <a href="/menuImages/<%=menuItem["menuImage"]%>">
                        <img class="rounded" src="/menuImages/<%=menuItem["menuImage"]%>" alt="" srcset="" height="30px">
                    </a>
                </td>
                <td><%=menuItem["menuCategory"]%></td>
                <td><%=menuItem["menuName"]%></td>
                <td>₱<%=parseFloat(menuItem["menuPrice"]).toFixed(2)%></td>
                <td>
                    <form action="updateStatus" method="post">
                        <input hidden type="text" name="updateStatus" value="<%=menuItem["menuStatus"]%>">
                        <% if (menuItem["menuStatus"]) { %>
                            <input hidden type="text" name="updateID" value="<%=menuItem["_id"]%>">
                            <button class="btn-sm btn-success rounded-pill" type="submit"><b>True</b></button>
                        <% } else {%>
                            <input hidden type="text" name="updateID" value="<%=menuItem["_id"]%>">
                            <button class="btn-sm btn-danger rounded-pill" type="submit"><b>False</b></button>
                        <% } %>
                    </form>
                </td>
                <td>
                    <button class="btn-sm btn-primary" onclick="editModal('<%-id%>')" data-bs-toggle="modal" data-bs-target="#edit_product">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
            <%id++%>
        <%}%>
    </tbody>
</table>

<!-- Add Product Modal -->
<div class="modal fade" id="add_product" tabindex="-1" aria-labelledby="addProductModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <!-- Title -->
        <div class="modal-header bg-success">
            <h5 class="modal-title text-light" id="addProductModal">Add Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form action="addNewProduct" method="POST">
                <!-- ID -->
                <div class="mb-3 row">
                    <label for="productId" class="col-sm-2 col-form-label">ID</label>
                    <div class="col-sm-10">
                        <input type="text" readonly class="form-control-plaintext" id="productId" value=<%=id%> name="menuID">
                    </div>
                </div>
                <!-- Image -->
                <div class="mb-3 row">
                    <label for="inputImage" class="col-sm-2 col-form-label">Image</label>
                    <div class="col-sm-10 d-flex flex-row">
                        <input type="file" class="form-control" id="inputImage" name="menuImage">
                    </div>
                </div>  
                <!-- Category -->
                <div class="mb-3 row">
                    <label for="selectMenuCategory" class="col-sm-2 col-form-label">Category</label>
                    <div class="col-sm-10">
                        <select class="form-select" size="3" aria-label="selectMenuCategory" id="selectMenuCategory" name="menuCategory">
                            <!-- EJS MENU CATEGORIES -->
                            <%for(category of categories[0]["categoryArray"]){%>
                                <option value="<%=category%>"><%=category%></option>
                            <%}%>
                        </select>
                    </div>
                </div>
                <!-- Product Name -->
                <div class="mb-3 row">
                    <label for="productName" class="col-sm-2 col-form-label">Product Name</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="productName" name="menuName">
                    </div>
                </div>
                <!-- Price -->
                <div class="mb-3 row">
                    <label for="productPrice" class="col-sm-2 col-form-label">Price</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <span class="input-group-text">₱</span>
                            <input type="number" min="1" step="any" class="form-control" id="productPrice" name="menuPrice">
                        </div>
                    </div>
                </div>
                <!-- Button Row -->
                <div class="mb-3 row">
                    <div class="d-flex flex-row-reverse">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-success me-2" type="submit">Add</button>
                    </div>
                </div>
            </form>
        </div>
      </div>
    </div>
</div>

<!-- Remove Product Modal -->
<div class="modal fade" id="remove_product" tabindex="-1" aria-labelledby="removeProductModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white" id="addProductModal">Remove Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4><b>Are you sure you want to remove these items?</b></h4>
                <form action="removeProduct" method="post">
                    <div class="card mb-3">
                        <ul class="list-group list-group-flush" id="toBeRemovedRows">
                            <h3 class='m-2'><b class='p-3 text-danger'>No Items Selected</b></h3>
                        </ul>
                    </div>
                    <div class="mb-3 row">
                        <div class="d-flex flex-row-reverse">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button class="btn btn-danger me-2" type="submit">Remove</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="edit_product" tabindex="-1" aria-labelledby="editProductModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <!-- Title -->
        <div class="modal-header bg-primary">
            <h5 class="modal-title text-light" id="addProductModal">Edit Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form action="editProduct" method="POST">
                <!-- ID -->
                <div class="mb-3 row">
                    <label for="productId" class="col-sm-2 col-form-label">ID</label>
                    <div class="col-sm-10">
                        <input hidden type="text" name="updateID" value="<%=menuItem["_id"]%>">
                        <input type="text" readonly class="form-control-plaintext" id="editProductId" value="" name="editMenuID">
                    </div>
                </div>
                <!-- Image -->
                <div class="mb-3 row">
                    <label for="inputImage" class="col-sm-2 col-form-label">Image</label>
                    <div class="col-sm-10 d-flex flex-row">
                        <input type="file" class="form-control" id="editInputImage" name="editMenuImage">
                    </div>
                </div>  
                <!-- Category -->
                <div class="mb-3 row">
                    <label for="selectMenuCategory" class="col-sm-2 col-form-label">Category</label>
                    <div class="col-sm-10">
                        <select class="form-select" size="3" aria-label="selectMenuCategory" id="editSelectMenuCategory" name="editMenuCategory">
                            <!-- EJS MENU CATEGORIES -->
                            <%for(category of categories[0]["categoryArray"]){%>
                                <option value="<%=category%>"><%=category%></option>
                            <%}%>
                        </select>
                    </div>
                </div>
                <!-- Product Name -->
                <div class="mb-3 row">
                    <label for="productName" class="col-sm-2 col-form-label">Product Name</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="editProductName" name="editMenuName">
                    </div>
                </div>
                <!-- Price -->
                <div class="mb-3 row">
                    <label for="productPrice" class="col-sm-2 col-form-label">Price</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <span class="input-group-text">₱</span>
                            <input type="number" min="1" step="any" class="form-control" id="editProductPrice" name="editMenuPrice">
                        </div>
                    </div>
                </div>
                <!-- Button Row -->
                <div class="mb-3 row">
                    <div class="d-flex flex-row-reverse">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-primary me-2" type="submit">Edit</button>
                    </div>
                </div>
            </form>
        </div>
      </div>
    </div>
</div>

<!-- Edit Menu Categories -->
<div class="modal fade" id="edit_category" tabindex="-1" aria-labelledby="editCategoryModal" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title text-white" id="editCategoryModal">Edit Menu Categories</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Add Category" id="addCategory">
                    <button class="btn btn-success" type="button" onclick="addCategoryRow()">Submit</button>
                </div>
                <form action="editMenuCategory" method="post">
                    <table class="table" id="categoryTable">
                        <thead>
                            <tr>
                                <th scope="col">Category Name</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <%var categoryId = 1;%>
                            <%if(categories[0] != undefined){ for(category of categories[0]["categoryArray"]){%>
                                <tr id="categoryRow<%=categoryId%>">
                                    <td><input hidden value=<%=category%> name="categories"><%=category%></td>
                                    <td>
                                        <a class="btn btn-sm text-danger h-25" id="removeCategory" onclick="removeCategoryRow('<%=categoryId%>')"><i class="fas fa-minus-circle"></i></a>
                                    </td>  
                                </tr>
                            <%categoryId++}}%>
                        </tbody>
                    </table>
                    <div class="mb-3 row">
                        <div class="d-flex flex-row-reverse">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button class="btn btn-primary me-2" type="submit">Submit Changes</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    var data = JSON.parse('<%-JSON.stringify(tableData)%>');
    var categories = JSON.parse('<%-JSON.stringify(categories)%>');

    // For main table checkboxes
    var checkedRowsArray = [];
    var checkedRowItems;
    var checkRows = document.getElementsByName("checkRow");
    var mainCheck = document.getElementById("mainCheck");

    var removeList = document.getElementById("toBeRemovedRows");
    var searchBox = document.getElementById("searchBox");

    // For Edit Category modal
    var editCategoryTable = document.getElementById("categoryTable");
    var editCategoryModal = document.getElementById('edit_category');
    var addCategory = document.getElementById("addCategory");
    
    // Gets data of selected row and transfers it to the modal.
    function editModal(menuID){
        var editID = document.getElementById("editProductId");
        var editCategory = document.getElementById("editSelectMenuCategory");
        var editName = document.getElementById("editProductName");
        var editPrice = document.getElementById("editProductPrice");

        editID.value = menuID;
        editCategory.value = data[menuID-1]["menuCategory"];
        editName.value = data[menuID-1]["menuName"];
        editPrice.value = data[menuID-1]["menuPrice"]["$numberDecimal"]; 
    }

    // Checks all the checkboxes when the main check box is checked.
    function checkAll(){
        checkedRowsArray = []; //Clear checked checkboxes first.
        if(mainCheck.checked){ //If Main Check is checked, loop through all checkboxes and change value to true.
            for(row of checkRows){
                row.checked = true;
                checkedRowsArray.push(row.value);
            }
            if(checkedRowsArray.length > 0){
                checkedRowItems = checkedRowsArray.map(id => {
                    for(menuItem of data){
                        if(menuItem["_id"] == id) {
                            return `<li class="list-group-item"><input class="form-check-input" type="checkbox" value="`+ menuItem["_id"] +`" name="toBeRemovedItem" checked><label class="form-check-label ps-3" for="toBeRemovedItem">`+ menuItem["menuName"] +`</label></li>`
                        }
                    }
                })
                removeList.innerHTML = checkedRowItems.join('');
            }
            else removeList.innerHTML = "<h2 class='m-2'><b class='p-3 text-danger'>No Items Selected</b></h2>";
        }
        else {
            for(row of checkRows) row.checked = false;
            checkedRowsArray = [];  
            removeList.innerHTML = "<h3 class='m-2'><b class='p-3 text-danger'>No Items Selected</b></h3>";
        }
    }

    // If all checkboxes are checked and user unchecks one, it unchecks the main check box.
    $('input[name="checkRow"]').change(function(){
        checkedRowsArray = [];

        for(row of checkRows) {
            if(row.checked) checkedRowsArray.push(row.value);

            if(!row.checked) {mainCheck.checked = false}
        }

        if(checkedRowsArray.length > 0){
            checkedRowItems = checkedRowsArray.map(id => {
                for(menuItem of data){
                    if(menuItem["_id"] == id) {
                        return `<li class="list-group-item"><input class="form-check-input" type="checkbox" value="`+ menuItem["_id"] +`" name="toBeRemovedItem" checked><label class="form-check-label ps-3" for="toBeRemovedItem">`+ menuItem["menuName"] +`</label></li>`
                    }
                }
            })
            removeList.innerHTML = checkedRowItems.join('');
        }
        else removeList.innerHTML = "<h2><b class='p-3 text-danger'>No Items Selected</b></h2>";
    });
    
    function addCategoryRow(){
        var nextRow = editCategoryTable.rows.length;
        var toBeAddedRow = 
        `<tr id="categoryRow`+nextRow+`" name="addRow">
            <td><input hidden value="`+addCategory.value+`" name="categories">`+addCategory.value+`</td>
            <td>
                <a class="btn btn-sm text-danger h-25" id="removeCategory" onclick="removeCategoryRow(`+nextRow+`)"><i class="fas fa-minus-circle"></i></a>
            </td>
        </tr>`;
        addCategory.value = "";
        $("#categoryTable tbody").append(toBeAddedRow);
    }

    function removeCategoryRow(rowNumber){
        var row = rowNumber;
        $("#categoryRow"+row).remove();
    }

    function reloadCategories(){
        $("#categoryTable tbody tr").remove();
        var id = 1;
        for(category of categories[0]["categoryArray"]){
            var toBeAddedRow = `<tr id="categoryRow`+id+`">
                <td><input hidden value="`+category+`" name="categories">`+category+`</td>
                <td>
                    <a class="btn btn-sm text-danger h-25" id="removeCategory" onclick="removeCategoryRow(`+id+`)"><i class="fas fa-minus-circle"></i></a>
                </td>                
            </tr>`
            $("#categoryTable tbody").append(toBeAddedRow);
            id++;
        }
    }

    editCategoryModal.addEventListener('hidden.bs.modal', function(event){
        addCategory.value = "";
        reloadCategories();
    });

     // Search function for table (NOT FUNCTIONING yet)
     function search(){
        $("#tableBody tr").remove();
        var id = 1;
        for(item of data){
            if(item["menuName"].includes(searchBox.value)){
                var toBeAdded = `
                <tr>
                    <td><input class="form-check-input" type="checkbox" value='`+ item["_id"] +`' name="checkRow">
                    <td>`+ id +`</td>
                    <td>
                        <a href="/menuImages/`+ item["menuImage"] +`">
                            <img src="/menuImages/`+ item["menuImage"] +`" alt="" srcset="" height="30px">
                        </a>
                    </td>
                    <td>`+ item["menuCategory"] +`</td>
                    <td>`+ item["menuName"] +`</td>
                    <td>₱`+ parseFloat(item["menuPrice"][0]).toFixed(2) +`</td>
                    <td>
                        <form action="updateStatus" method="post">
                            <input hidden type="text" name="updateStatus" value="`+item["menuStatus"]+`">`;

                if(item["menuStatus"]){
                    toBeAdded += `<input hidden type="text" name="updateID" value="`+item["_id"]+`">
                    <button class="btn-sm btn-success rounded-pill" type="submit"><b>True</b></button>`;
                }
                else{
                    toBeAdded += `<input hidden type="text" name="updateID" value="`+item["_id"]+`">
                    <button class="btn-sm btn-danger rounded-pill" type="submit"><b>False</b></button>`;
                }

                toBeAdded += `</form>
                    </td>
                        <td>
                            <button class="btn-sm btn-primary" onclick="editModal('`+id+`')" data-bs-toggle="modal" data-bs-target="#edit_product">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>`;
                $("#tableBody").append(toBeAdded);  
                id++;
            }
        }
    }

</script>